flowchart TD
    A["ðŸ“„ Start: Transcript File
    Diarized text with speaker labels
    ðŸ“œ run_multilevel_extraction.py"] --> B["ðŸ” Parse Transcript
    Extract speaker, timestamp, text
    ðŸ“œ transcript_parser.py::parse_file()"]
    
    B --> C["âœ‚ï¸ Split into Utterances
    Each line becomes one utterance
    ðŸ“œ transcript_parser.py::Utterance"]
    
    C --> D{"ðŸ”„ For Each Utterance
    Process 1 by 1 or in parallel
    ðŸ“œ extractor.py::extract_from_file()"}
    
    D --> E["ðŸš¦ Stage 1: Belief Filter
    Q1: Contains identifiable belief?
    Q2: Reveals what speaker believes?
    Q3: Endorsed by speaker?
    Q4: Reveals worldview/preferences?
    ðŸ“œ classifier.py::stage1_filter()"]
    
    E --> F{"â“ Is Belief?
    Check filter confidence score
    ðŸ“œ classifier.py::classify()"}
    
    F -->|"âŒ No - 70% filtered out"| G["â­ï¸ Skip
    Questions, ads, greetings"]
    
    F -->|"âœ… Yes - 30% pass filter"| H["âš¡ Extract Atomic Beliefs
    NEW: Clean standalone statements
    ðŸ“œ classifier.py::extract_atomic_beliefs()"]
    
    H --> I["ðŸŽ¯ Get Statement + Certainty
    binary or hedged classification
    ðŸ“œ prompts/atomic_belief_extraction.txt"]
    
    I --> J["ðŸ§  Stage 2: Full Classification
    26+ analysis questions via LLM
    ðŸ“œ classifier.py::stage2_classify()"]
    
    J --> K["ðŸ† Determine Primary Tier
    Which of 10 tiers fits best
    ðŸ“œ prompts/stage2_classify.txt"]
    J --> L["ðŸ“Š Generate 10 Abstractions
    Core Axioms â†’ Loose Takes
    ðŸ“œ prompts/tier_abstraction.txt"]
    J --> M["ðŸ’ª Conviction & Stability
    How strong + how stable 0-1
    ðŸ“œ prompts/stage2_classify.txt"]
    J --> N["ðŸŒ Score 4 Domains
    Sci/tech, phil/religious, financial, political
    ðŸ“œ prompts/stage2_classify.txt"]
    J --> O["ðŸ·ï¸ Assign Category
    epistemic, moral, political, etc.
    ðŸ“œ prompts/stage2_classify.txt"]
    
    K --> P["ðŸ“¦ Compile Belief Record
    Combine all fields into one row
    ðŸ“œ classifier.py::BeliefClassification"]
    L --> P
    M --> P
    N --> P
    O --> P
    I --> P
    
    P --> Q{"ðŸ” More Utterances?
    Continue until all processed
    ðŸ“œ classifier.py::classify_batch()"}
    
    Q -->|Yes| D
    Q -->|No| R["ðŸ—‚ï¸ Create DataFrame
    Convert to pandas table
    ðŸ“œ extractor.py::_to_dataframe()"]
    
    R --> S["âž• Add New Columns
    atomic_belief, certainty + 14 others
    ðŸ“œ extractor.py::_to_dataframe()"]
    
    S --> T["ðŸ’¾ Save Output
    CSV/Parquet with all weights
    ðŸ“œ multilevel_extractor.py::save_output()"]
    
    T --> U["ðŸ“ˆ Calculate Summary Stats
    Counts, averages, costs
    ðŸ“œ multilevel_extractor.py::get_cost_stats()"]
    
    U --> V["âœ¨ Display Results
    Total beliefs, speakers, cost
    ðŸ“œ run_multilevel_extraction.py"]
    
    classDef newFeature fill:#90EE90,stroke:#2d5016,stroke-width:2px,color:#000
    classDef aiStep fill:#87CEEB,stroke:#104e8b,stroke-width:2px,color:#000
    classDef dataStep fill:#FFE4B5,stroke:#8b6914,stroke-width:2px,color:#000
    
    class H,I,S newFeature
    class E,J aiStep
    class R,T,U dataStep

