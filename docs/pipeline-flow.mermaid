flowchart TD
    A["ðŸ“„ Start: Transcript File
    Diarized text with speaker labels
    ðŸ“œ run_multilevel_extraction.py"] --> B["ðŸ” Parse Transcript
    Extract speaker, timestamp, text
    ðŸ“œ transcript_parser.py::parse_file()"]
    
    B --> C["âœ‚ï¸ Split into Utterances
    Each line becomes one utterance
    ðŸ“œ transcript_parser.py::Utterance"]
    
    C --> D{"ðŸ”„ For Each Utterance
    Process 1 by 1 or in parallel
    ðŸ“œ extractor.py::extract_from_file()"}
    
    D --> E["ðŸš¦ Stage 1: Belief Filter
    Q1: Contains identifiable belief?
    Q2: Reveals what speaker believes?
    Q3: Endorsed by speaker?
    Q4: Reveals worldview/preferences?
    ðŸ“œ classifier.py::stage1_filter()"]
    
    E --> F{"â“ Is Belief?
    Check filter confidence score
    ðŸ“œ classifier.py::classify()"}
    
    F -->|"âŒ No - 70% filtered out"| G["â­ï¸ Skip
    Questions, ads, greetings"]
    
    F -->|"âœ… Yes - 30% pass filter"| H["âš¡ Extract Atomic Beliefs
    Extract ALL distinct beliefs as clean statements
    Remove quotes, questions, fluff
    Preserve speaker's intent
    ðŸ“œ classifier.py::extract_atomic_beliefs()"]
    
    H --> I["ðŸŽ¯ Classify Certainty
    binary: absolute statements
    hedged: contains uncertainty markers
    ðŸ“œ prompts/atomic_belief_extraction.txt"]
    
    I --> J["ðŸ§  Stage 2: Full Classification
    Q5-7: Conviction indicators
    Q8-13: Belief type classification
    Q14-15: Claim type
    Q16-26: Tier determination
    Q27-28: Scoring
    Q29-31: Categorization
    ðŸ“œ classifier.py::stage2_classify()"]
    
    J --> K["ðŸ† Determine Primary Tier Q16-26
    Core Axiom? Worldview Pillar?
    Identity Value? Meta-Principle?
    Cross-Domain Rule? Domain Belief?
    Strategy? Claim? Opinion? Joke?
    ðŸ“œ prompts/stage2_classify.txt"]
    J --> L["ðŸ“Š Generate 10 Abstractions
    Rewrite belief at each tier level
    Tier 1 Core Axioms â†’ Tier 10 Loose Takes
    ðŸ“œ prompts/tier_abstraction.txt"]
    J --> M["ðŸ’ª Conviction & Stability Q27-28
    Q27: How strong is conviction? 0-1
    Q28: How stable/long-term? 0-1
    ðŸ“œ prompts/stage2_classify.txt"]
    J --> N["ðŸŒ Score 4 Domains
    Scientific/tech, philosophical/religious
    Financial, political 0-1 each
    ðŸ“œ prompts/stage2_classify.txt"]
    J --> O["ðŸ·ï¸ Assign Category Q29-31
    Q29: epistemic, moral, political, etc.
    Q30: Parent hint higher-level belief
    Q31: Defines outgroup? yes/no
    ðŸ“œ prompts/stage2_classify.txt"]
    
    K --> P["ðŸ“¦ Compile Belief Record
    Combine all fields into one row
    ðŸ“œ classifier.py::BeliefClassification"]
    L --> P
    M --> P
    N --> P
    O --> P
    I --> P
    
    P --> Q{"ðŸ” More Utterances?
    Continue until all processed
    ðŸ“œ classifier.py::classify_batch()"}
    
    Q -->|Yes| D
    Q -->|No| R["ðŸ—‚ï¸ Create DataFrame
    Convert to pandas table
    ðŸ“œ extractor.py::_to_dataframe()"]
    
    R --> S["âž• Add New Columns
    atomic_belief, certainty + 14 others
    ðŸ“œ extractor.py::_to_dataframe()"]
    
    S --> T["ðŸ’¾ Save Output
    CSV/Parquet with all weights
    ðŸ“œ multilevel_extractor.py::save_output()"]
    
    T --> U["ðŸ“ˆ Calculate Summary Stats
    Counts, averages, costs
    ðŸ“œ multilevel_extractor.py::get_cost_stats()"]
    
    U --> V["âœ¨ Display Results
    Total beliefs, speakers, cost
    ðŸ“œ run_multilevel_extraction.py"]
    
    classDef newFeature fill:#90EE90,stroke:#2d5016,stroke-width:2px,color:#000
    classDef aiStep fill:#87CEEB,stroke:#104e8b,stroke-width:2px,color:#000
    classDef dataStep fill:#FFE4B5,stroke:#8b6914,stroke-width:2px,color:#000
    
    class H,I,S newFeature
    class E,J aiStep
    class R,T,U dataStep

