flowchart TD
    A["ðŸ“„ Start: Transcript File
    Diarized text with speaker labels
    ðŸ“œ run_multilevel_extraction.py"] --> B["ðŸ” Parse Transcript
    Extract speaker, timestamp, text
    ðŸ“œ transcript_parser.py::parse_file()"]
    
    B --> C["âœ‚ï¸ Split into Utterances
    Each line becomes one utterance
    ðŸ“œ transcript_parser.py::Utterance"]
    
    C --> D{"ðŸ”„ For Each Utterance
    Process 1 by 1 or in parallel
    ðŸ“œ extractor.py::extract_from_file()"}
    
    D --> E["ðŸš¦ Stage 1: Belief Filter
    Q1: Does this text contain at least one identifiable belief or value judgment?
    Q2: Does this statement reveal what the speaker believes, even implicitly?
    Q3: Is this belief likely endorsed or sympathetically discussed by the speaker?
    Q4: Does this belief reveal anything about the speaker's worldview or preferences?
    Pass: Q2+Q3+Q4=YES OR confidenceâ‰¥0.6
    ðŸ“œ classifier.py::stage1_filter()"]
    
    E --> F{"â“ Is Belief?
    Check filter confidence score
    ðŸ“œ classifier.py::classify()"}
    
    F -->|"âŒ No - 70% filtered out"| G["â­ï¸ Skip
    Questions, ads, greetings"]
    
    F -->|"âœ… Yes - 30% pass filter"| H["âš¡ Extract Atomic Beliefs
    Rules: 1. Extract ALL distinct beliefs/claims
    2. Each must be clear, standalone, atomic
    3. Remove quotes, questions, narration, fluff
    4. Do NOT add new meaning
    5. Preserve speaker's intent
    6. Return empty array if no beliefs
    ðŸ“œ classifier.py::extract_atomic_beliefs()"]
    
    H --> I["ðŸŽ¯ Classify Certainty
    binary: Absolute with no hedging
    hedged: Contains uncertainty markers might/could/probably/I think
    ðŸ“œ prompts/atomic_belief_extraction.txt"]
    
    I --> J["ðŸ§  Stage 2: Full Classification
    Q5: Wording indicate strong/absolute commitment always/never/must/cannot?
    Q6: Context suggest speaker repeats or consistently relies on this?
    Q7: Speaker defend or justify against alternatives or objections?
    Q8: About fundamental nature of reality, human nature, purpose, existence?
    Q9: About how truth/knowledge formed, who/what to trust, evaluate info?
    Q10: About broad moral principles right/wrong good/bad across situations?
    Q11: Cross-domain principle speaker applies in multiple areas of life?
    Q12: Primarily about large-scale systems state/markets/money/religion/tech/law?
    Q13: Mainly about one specific domain Bitcoin/real estate/AI/health/education?
    Q14: Concrete, testable, time-bound claim prediction/number/causal/empirical?
    Q15: Casual preference, offhand comment, joke, brand line, exploratory musing?
    ðŸ“œ classifier.py::stage2_classify()"]
    
    J --> K["ðŸ† Determine Primary Tier Q16-26
    Q16: Core Axiom foundational, cross-domain, defended, stable?
    Q17: Worldview Pillar big-picture moral/political/economic frame?
    Q18: Identity-Defining Value this is who I am/we are?
    Q19: Meta-Principle rule for how to choose/update beliefs?
    Q20: Cross-Domain Rule or Heuristic action rule in many contexts?
    Q21: Stable Domain Belief consistent stance within one topic?
    Q22: Repeated Strategy or Playbook tactic speaker endorses/uses?
    Q23: Concrete Claim or Prediction?
    Q24: Situational Opinion tied to narrow context?
    Q25: Loose Take/Joke/Aesthetic Vibe?
    Q26: What is the SINGLE BEST-FITTING tier?
    ðŸ“œ prompts/stage2_classify.txt"]
    J --> L["ðŸ“Š Generate 10 Abstractions
    Rewrite belief at each tier level
    Tier 1 Core Axioms â†’ Tier 10 Loose Takes
    ðŸ“œ prompts/tier_abstraction.txt"]
    J --> M["ðŸ’ª Conviction & Stability Q27-28
    Q27: On 0-1 scale, how strong is speaker's conviction in this belief?
    Q28: On 0-1 scale, how stable/long-term does this belief appear?
    ðŸ“œ prompts/stage2_classify.txt"]
    J --> N["ðŸŒ Score 4 Domains
    Scientific/tech, philosophical/religious
    Financial, political 0-1 each
    ðŸ“œ prompts/stage2_classify.txt"]
    J --> O["ðŸ·ï¸ Assign Category Q29-31
    Q29: Single best-fitting category: epistemic, moral, political, economic, spiritual, social, tech, health, bitcoin/finance, other
    Q30: In one short phrase, what higher-level belief or axiom does this rely on? parent_hint - leave empty if foundational
    Q31: Does this belief explicitly reject or oppose another belief/group/position in-group vs out-group?
    ðŸ“œ prompts/stage2_classify.txt"]
    
    K --> P["ðŸ“¦ Compile Belief Record
    Combine all fields into one row
    ðŸ“œ classifier.py::BeliefClassification"]
    L --> P
    M --> P
    N --> P
    O --> P
    I --> P
    
    P --> Q{"ðŸ” More Utterances?
    Continue until all processed
    ðŸ“œ classifier.py::classify_batch()"}
    
    Q -->|Yes| D
    Q -->|No| R["ðŸ—‚ï¸ Create DataFrame
    Convert to pandas table
    ðŸ“œ extractor.py::_to_dataframe()"]
    
    R --> S["âž• Add New Columns
    atomic_belief, certainty + 14 others
    ðŸ“œ extractor.py::_to_dataframe()"]
    
    S --> T["ðŸ’¾ Save Output
    CSV/Parquet with all weights
    ðŸ“œ multilevel_extractor.py::save_output()"]
    
    T --> U["ðŸ“ˆ Calculate Summary Stats
    Counts, averages, costs
    ðŸ“œ multilevel_extractor.py::get_cost_stats()"]
    
    U --> V["âœ¨ Display Results
    Total beliefs, speakers, cost
    ðŸ“œ run_multilevel_extraction.py"]
    
    classDef newFeature fill:#90EE90,stroke:#2d5016,stroke-width:2px,color:#000
    classDef aiStep fill:#87CEEB,stroke:#104e8b,stroke-width:2px,color:#000
    classDef dataStep fill:#FFE4B5,stroke:#8b6914,stroke-width:2px,color:#000
    
    class H,I,S newFeature
    class E,J aiStep
    class R,T,U dataStep

